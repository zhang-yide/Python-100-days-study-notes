### 概述

#### 作用

**数据持久化** - 将数据保存到能够长久保存数据的存储介质中，在掉电的情况下数据也不会丢失。

#### 关系数据库特点

- 理论基础：集合论和关系代数。
- 具体表象：用二维表（有行和列）组织数据。
- 编程语言：结构化查询语言（SQL：Structured Query Language）。

### 安装和配置

#### 下载 MySQL

要在 Linux 上安装 MySQL，可以使用发行版的包管理器。例如，Ubuntu用户可以简单地通过命令`apt-get install mysql-server`安装最新的 MySQL 版本。

要在 Windows 或 Mac 上安装 MySQL，首先从 MySQL 官方网站下载最新的 MySQL Community Server 版本：

https://dev.mysql.com/downloads/mysql/

选择对应的操作系统版本，下载即可。

#### 安装 MySQL

1. 解压 zip 包到安装目录：

例如我解压至`D:\programs\mysql-8.0.18-winx64`

2. 配置环境变量：

将解压后的文件夹 bin 的路径添加到系统环境变量中，即`D:\programs\mysql-8.0.18-winx64\bin`

3. 配置初始化的`my.ini`文件：

安装目录下新建`my.ini`文件，写入如下基本配置：

```
[mysqld]
# 设置3306端口
port=3306
# 设置mysql的安装目录
basedir=D:\\programs\\mysql-8.0.18-winx64   
# 切记此处一定要用双斜杠\\，单斜杠我这里会出错，不过看别人的教程，有的是单斜杠。自己尝试吧
# 设置mysql数据库的数据的存放目录
datadir=D:\\programs\\mysql-8.0.18-winx64\\Data   # 此处同上
# 允许最大连接数
max_connections=200
# 允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统
max_connect_errors=10
# 服务端使用的字符集默认为UTF8
character-set-server=utf8
# 创建新表时将使用的默认存储引擎
default-storage-engine=INNODB
# 默认使用“mysql_native_password”插件认证
default_authentication_plugin=mysql_native_password
[mysql]
# 设置mysql客户端默认字符集
default-character-set=utf8
[client]
# 设置mysql客户端连接服务端时默认使用的端口
port=3306
default-character-set=utf8
```

4. 安装 MySQL

在安装时，需要以管理员身份运行 cmd ，否则在安装时会报错。

#### 初始化 MySQL

1. 初始化数据库

在 bin 目录下执行：

`mysqld --initialize --console`

执行完毕后，会在最后打印 root 用户的初始密码，如：

`2018-04-28T15:57:24.859249Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: rI5rvf5x5G`

其中`rI5rvf5x5G`就是初始密码。后面登录要用到。如果没记住，删掉初始化的 datadir 目录，再执行一遍初始化命令，又会重新生成的。

2. 安装服务

在 bin 目录下执行：

`mysqld --install [服务名]`

默认服务名为 mysql。

安装完成之后，就可以通过命令`net start mysql`启动 MySQL 的服务了。通过命令`net stop mysql`停止服务。通过命令`sc delete MySQL/mysqld -remove`卸载 MySQL 服务。

3. 更改密码

在 bin 目录下执行：

`mysql -u root -p`

> 说明：启动客户端时，-u 参数用来指定用户名，MySQL 默认的超级管理账号为 root；-p 表示要输入密码（用户口令）；如果连接的是其他主机而非本机，可以用 -h 来指定连接主机的主机名或 IP 地址。

输入之前的密码即可进入 MySQL 命令模式。

在 MySQL 中执行命令：

`ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '新密码'; `

#### 常用命令

   - 查看服务器版本。

     ```SQL
     select version();
     ```

   - 查看所有数据库。

     ```SQL
     show databases;
     ```

   - 切换到指定数据库。

     ```SQL
     use mysql;
     ```

   - 查看数据库下所有表。

     ```Shell
     show tables;
     ```

   - 获取帮助。

     ```SQL
     ? contents;
     ? functions;
     ? numeric functions;
     ? round;
     
     ? data types;
     ? longblob;
     ```

### SQL 详解

#### 基本操作

总的来说，SQL语言定义了这么几种操作数据库的能力：

- DDL（数据定义语言）：Data Definition Language

DDL允许用户定义数据，也就是创建表(create)、删除表(drop)、修改表(alter)结构这些操作。通常，DDL由数据库管理员执行。

- DML（数据操作语言）：Data Manipulation Language

DML为用户提供添加(insert)、删除(delete)、更新(update)数据的能力，这些是应用程序对数据库的日常操作。

- DQL（数据查询语言）：Data Query Language

DQL允许用户查询(select)数据，这也是通常最频繁的数据库日常操作。

- DCL(数据控制语言）：Data Control Language

DCL通常用于授予权限（grant）和召回权限（revoke）。

#### 关系模型

1. 主键

主键是关系表中记录的唯一标识。主键的选取非常重要：主键不要带有业务含义，而应该使用 BIGINT 自增或者 GUID(Globally Unique Identifier) 类型。主键也不应该允许`NULL`。

可以使用多个列作为联合主键，但联合主键并不常用。

2. 外键

关系数据库通过外键可以实现一对多、多对多和一对一的关系。外键既可以通过数据库来约束，也可以不设置约束，仅依靠应用程序的逻辑来保证。

在students表中，通过class_id的字段，可以把数据与另一张表关联起来，这种列称为**外键**。外键并不是通过列名实现的，而是通过定义外键约束实现的：

```sql
alter table students
add constraint fk_class_id
foreign key (class_id)
references classes (id);
```

其中，外键约束的名称`fk_class_id`可以任意，`foreign key (class_id)`指定了`class_id`作为外键，`references classes (id)`指定了这个外键将关联到`classes`表的`id`列（即`classes`表的主键）。

通过定义外键约束，关系数据库可以保证无法插入无效的数据。即如果`classes`表不存在`id=99`的记录，`students`表就无法插入`class_id=99`的记录。

由于外键约束会降低数据库的性能，大部分互联网应用程序为了追求速度，并不设置外键约束，而是仅靠应用程序自身来保证逻辑的正确性。这种情况下，`class_id`仅仅是一个普通的列，只是它起到了外键的作用而已。

要删除一个外键约束，也是通过`alter table`实现的：

```sql
alter table students
drop foreign key fk_class_id;
```

> 注意：删除外键约束并没有删除外键这一列。删除列是通过`drop column ...`实现的。

3. 索引

索引是关系数据库中对某一列或多个列的值进行预排序的数据结构。通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度。

如果要经常根据score列进行查询，就可以对score列创建索引：

```sql
alter table students
add index idx_score (score);
```

使用`add index idx_score (score)`就创建了一个名称为`idx_score`，使用列`score`的索引。索引名称是任意的，索引如果有多列，可以在括号里依次写上，例如：

```sql
alter table students
add index idx_score (name, score);
```

索引的效率取决于索引列的值是否散列，即该列的值如果越互不相同，那么索引效率越高。

对于主键，关系数据库会自动对其创建主键索引。使用主键索引的效率是最高的，因为主键会保证绝对唯一。

4. 唯一索引

在设计关系数据表的时候，看上去唯一的列，例如身份证号、邮箱地址等，因为他们具有业务含义，因此不宜作为主键。

但是，这些列根据业务要求，又具有唯一性约束：即不能出现两条记录存储了同一个身份证号。这个时候，就可以给该列添加一个唯一索引。例如，我们假设students表的name不能重复：

```sql
alter table students
add unique index uni_name (name);
```

通过`unique`关键字我们就添加了一个唯一索引。

也可以只对某一列添加一个唯一约束而不创建唯一索引：

```sql
alter table students
add constraint uni_name unique (name);
```

这种情况下，`name`列没有索引，但仍然**具有唯一性保证**。

#### 查询数据

1. 基本查询

```sql
select * from <表名>;
```

- 查询所有内容：

```sql
mysql> select * from students;
```

2. 条件查询

```sql
select * from <表名> where <条件>
```

- 查询分数在80分或以上的学生：

```sql
select * from students where score >= 80;
```

- 查询分数在80分或以上的男生：

```sql
select * from students where score >= 80 and gender = 'M';
```

- 查询分数为60、90、80的学生：

```sql
select * from students where score in (60,90,80);
```

- 查询姓‘王’的学生：

```sql
select * from students where name like '王%';
```

- 其他常用的条件表达式：

    - `<>`:不等于
    - `like`:判断相似
    
    > `name like 'ab%'`:%表示任意字符，例如'ab%'将匹配'ab'，'abc'，'abcd'

3. 投影查询

```sql
select 列1 [别名], 列2 [别名], 列3 [别名] from ...;
```

- 查询分数在80分或以上学生的姓名和分数：

```sql
mysql> select name, score from students where score >=80;
+--------+-------+
| name   | score |
+--------+-------+
| 小明   |    90 |
| 小红   |    95 |
| 小军   |    88 |
| 小白   |    81 |
| 小林   |    85 |
| 小新   |    91 |
| 小王   |    89 |
| 小丽   |    85 |
+--------+-------+
8 rows in set (0.00 sec)
```

- 查询分数在80分或以上学生的姓名和分数，并重命名分数列为`points`：

```sql
mysql> select name, score points from students where score >=80;
+--------+--------+
| name   | points |
+--------+--------+
| 小明   |     90 |
| 小红   |     95 |
| 小军   |     88 |
| 小白   |     81 |
| 小林   |     85 |
| 小新   |     91 |
| 小王   |     89 |
| 小丽   |     85 |
+--------+--------+
8 rows in set (0.00 sec)
```

4. 排序

```sql
... order by 列 [DESC];
```

```sql
... order by 列 [ASC];
```


默认的排序规则是`ASC`(ascend)：“升序”，即从小到大。`ASC`可以省略，即`order by score ASC`和`order by score`效果一样。“降序”为`DESC`(descend)。

- 查询分数在80分或以上的学生,并按分数降序显示：

```sql
mysql> select * from students where score >= 80 order by score desc;
```

5. 分页查询

```sql
limit <M> offset <N>`或`limit <N>, <M>;
```

`N`指起始条目，`M`指每页条目数。

```sql
mysql> select * from students limit 3 offset 0;
+----+----------+--------+--------+-------+
| id | class_id | name   | gender | score |
+----+----------+--------+--------+-------+
|  1 |        1 | 小明   | M      |    90 |
|  2 |        1 | 小红   | F      |    95 |
|  3 |        1 | 小军   | M      |    88 |
+----+----------+--------+--------+-------+
3 rows in set (0.00 sec)

mysql> select * from students limit 3 offset 1;
+----+----------+--------+--------+-------+
| id | class_id | name   | gender | score |
+----+----------+--------+--------+-------+
|  2 |        1 | 小红   | F      |    95 |
|  3 |        1 | 小军   | M      |    88 |
|  4 |        1 | 小米   | F      |    73 |
+----+----------+--------+--------+-------+
3 rows in set (0.00 sec)

mysql> select * from students limit 1, 4;
+----+----------+--------+--------+-------+
| id | class_id | name   | gender | score |
+----+----------+--------+--------+-------+
|  2 |        1 | 小红   | F      |    95 |
|  3 |        1 | 小军   | M      |    88 |
|  4 |        1 | 小米   | F      |    73 |
|  5 |        2 | 小白   | F      |    81 |
+----+----------+--------+--------+-------+
4 rows in set (0.00 sec)
```

> `limit`总是设定为`pageSize`；

> `offset`计算公式为`pageSize * (pageIndex - 1)`。

6. 聚合查询

- 统计分数在80分或以上的学生共多少个：

```sql
mysql> select count(*) from students where score >= 80;
+----------+
| count(*) |
+----------+
|        8 |
+----------+
1 row in set (0.35 sec)
```

- 其他聚合函数：
    - `sum`：合计值
    - `avg`：平均值
    - `max`：最大值
    - `min`：最小值
    > 注意：如果聚合查询的`where`条件没有匹配到任何行，`count()`会返回`0`，而`sum()`、`avg()`、`max()`和`min()`会返回`NULL`

- 统计各班平均分；

```sql
mysql> select class_id, avg(score) avg from students group by class_id;
+----------+---------+
| class_id | avg     |
+----------+---------+
|        1 | 86.5000 |
|        2 | 73.6667 |
|        3 | 88.3333 |
+----------+---------+
3 rows in set (0.00 sec)
```

7. 多表查询

```sql
select 表名1.列名, 表名2.列名 from 表1, 表2;
```

```sql
select 别名1.列名, 别名2.列名 from 表1 别名1, 表2 别名2;
```

```sql
mysql> select s.name, s.gender, s.score, c.name
    -> from students s, classes c
    -> where s.gender = 'M' and c.id = 1;
+--------+--------+-------+--------+
| name   | gender | score | name   |
+--------+--------+-------+--------+
| 小明   | M      |    90 | 一班   |
| 小军   | M      |    88 | 一班   |
| 小兵   | M      |    55 | 一班   |
| 小林   | M      |    85 | 一班   |
| 小王   | M      |    89 | 一班   |
+--------+--------+-------+--------+
5 rows in set (0.00 sec)
```

8. 连接查询
